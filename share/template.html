<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>Rails Model Visualizer</title>
        <meta charset="utf-8">
        <!-- d3 3.5.5 included from gem directory -->
        <script src="<%= @d3 %>" charset="utf-8"></script>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <style type="text/css">
            body {
                font-family: 'Open Sans', sans-serif;
            }
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                overflow: scroll;
                border-right: 1px solid #999;
                width: 18%;
                color: #222;
                background-color: #eee;
            }
            .sidebar > div {
                padding: 7px 15px;
            }
            .sidebar input {
                width: 100%;
                font-size: 16px;
            }
            .sidebar > .model {
                font-size: 20px;
                cursor: pointer;
            }
            .sidebar > .model:hover {
                background-color: #2980b9;
                color: #eee;
            }
        </style>
    </head>

    <body>
        <%= @sidebar %>

        <script>
            (function() {
                // Model data is inserted from visualizer.rb
                var data = <%= @models %>;
                var nodes = [];
                var links = [];
                var node;

                // Create node array and number each one
                var i = 0;
                for (var name in data) {
                    if (data.hasOwnProperty(name)) {
                        node = data[name];
                        node.node_number = i++;
                        nodes.push({
                            name: name,
                            group: 1,
                            schema_info: node.schema_info
                        });
                    }
                }

                // Create links array using associations
                for (var name in data) {
                    if (data.hasOwnProperty(name)) {
                        node = data[name];
                        for (var assn_type in node.associations) {
                            node.associations[assn_type].forEach(function(assn) {
                                if (assn in data) {
                                    links.push({
                                        source: node.node_number,
                                        target: data[assn].node_number,
                                        type: assn_type
                                    });
                                } else {
                                    console.log('ERROR: association not found. ' + name + ' -> ' + assn)
                                }
                            });
                        }
                    }
                }

                var width = window.innerWidth,
                    height = window.innerHeight;

                var color = d3.scale.category20();

                var force = d3.layout
                              .force()
                              .charge(-450)
                              .linkDistance(150)
                              .size([width, height]);

                var svg = d3.select("body")
                            .append("svg")
                            .attr("width", width)
                            .attr("height", height);

                force.nodes(nodes)
                     .links(links)
                     .start();

                var link = svg.selectAll(".link")
                              .data(links)
                              .enter().append("line")
                              .attr("class", "link")
                              .style("stroke", function(d) {
                                  switch(d.type) {
                                      case "belongs_to":
                                          return "#000";
                                      case "has_and_belongs_to_many":
                                          return "#f00";
                                      case "has_many":
                                          return "#0f0";
                                      case "has_one":
                                          return "#00f";
                                      default:
                                          return "#999";
                                  }
                              }).style("stroke-width", function(d) { return Math.sqrt(d.value); });

                // Create the node groups under svg
                var gnodes = svg.selectAll('g.gnode')
                                .data(nodes)
                                .enter()
                                .append('g')
                                .classed('gnode', true);

                // Add circle to each group
                node = gnodes.append("circle")
                             .attr("class", "node")
                             .attr("r", 15)
                             .style("fill", function(d) { return color(d.group); })
                             .call(force.drag);

                // Append labels to each group
                var labels = gnodes.append("text")
                                   .text(function(d) { return d.name; });

                // Show model attributes on hover
                node.append("title").text(function(d) {
                    var description = d.name + '\r\n';

                    for (var attr in d.schema_info) {
                        if (d.schema_info[attr].length > 0) {
                            description += '\r\n' + attr + ": " + d.schema_info[attr].join(', ');
                        }
                    }

                    return description;
                });

                force.on("tick", function() {
                    link.attr("x1", function(d) { return d.source.x; })
                        .attr("y1", function(d) { return d.source.y; })
                        .attr("x2", function(d) { return d.target.x; })
                        .attr("y2", function(d) { return d.target.y; });

                    // Translate the groups
                    gnodes.attr("transform", function(d) {
                        return 'translate(' + [d.x, d.y] + ')';
                    });
                    // node.attr("cx", function(d) { return d.x; })
                    //     .attr("cy", function(d) { return d.y; });
                });

                // Search functionality for sidebar
                var searchdiv = document.getElementsByClassName('sidebar')[0].firstChild;
                var searchfield = searchdiv.firstChild;
                searchfield.oninput = function() {
                    var sidebarentries = document.getElementsByClassName('model');
                    var search = searchfield.value.toLowerCase();
                    for (var i = 0; i < sidebarentries.length; i++) {
                        var entry = sidebarentries[i];
                        var html = entry.innerHTML.toLowerCase();
                        if (html.indexOf(search) == -1) {
                            entry.style.display = 'none';
                        } else {
                            entry.style.display = 'block';
                        }
                    }
                }

                // Highlight node on click. Must be global.
                window.highlightNode = function(name) {
                    // Dim all links and all nodes but the one with the given name
                    svg.selectAll(".gnode").filter(function (d, i) {
                        return d.name != name;
                    }).style("opacity", "0.1");
                    svg.selectAll(".link").style("opacity", "0.1");

                    // TODO: display tooltip and keep everything else dimmed to undim later
                    d3.selectAll(".gnode, .link").transition()
                                                 .duration(5000)
                                                 .style("opacity", "1");
                }
            })();
        </script>
    </body>
</html>